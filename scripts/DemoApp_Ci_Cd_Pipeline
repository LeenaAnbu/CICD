def slackChannel = "#general"

node() {
	deleteDir()
	try {
		stage("SCM Code Checkout") {
			checkoutGit('master', "DemoJavaApp", "https://github.com/RamKannan91/DemoJavaApp.git")
        }

	    stage("Maven Build") {
    	    withMaven(maven: 'maven3') {
    	       sh "cd DemoJavaApp/ ; mvn clean install"
    	    }
	    }

	    stage("Upload Artifacts") {
	        withMaven(maven: 'maven3') {
	    	    sh "cd DemoJavaApp/ ; mvn deploy:deploy-file -DgroupId=workshop -DartifactId=DemoApp -Dversion=1.0.2-SNAPSHOT -DgeneratePom=false -Dpackaging=war -DrepositoryId=maven-snapshots -Durl=http://localhost:8081/repository/maven-snapshots/ -DpomFile=pom.xml -Dfile=target/MavenWebApp.war"
	        }
	   }

	    stage("Deploy Dev (Ansible)") {
        	sh "ansible-playbook DemoJavaApp/scripts/deployWar.yml --connection=local -e nexus_path=${env.NEXUS_URL}' -e tomcat_path='${env.TOMCAT_PATH}'"
	    }

	    stage("Deploy Dev (Container)") {
	    	app = docker.build("DemoJavaApp/scripts/Dockerfile")
	    	docker.withRegistry('https://registry.hub.docker.com', 'docker-hub-credentials') {
	            app.push("${env.BUILD_NUMBER}")
	            app.push("latest")
	        }
	    }

	    stage("Run Tests") {

	    }

	    stage("Post Build") {
	    	currentBuild.displayName = "DevEnv-${env.BUILD_NUMBER}" 
	    	slackSuccess(slackChannel)
	    }
    } catch (err) {
        println("================ ERROR: ${err}")
		currentBuild.displayName = "DevEnv-${env.BUILD_NUMBER}" 
    	slackFailure(slackChannel)
        currentBuild.result = "FAILURE"
        error()
    }
}

def checkoutGit(branchName, targetDir, repoURL) {
    checkout([$class: 'GitSCM',
      branches: [[name: branchName]],
      doGenerateSubmoduleConfigurations: false,
      extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: targetDir]],
      submoduleCfg: [],
      userRemoteConfigs: [[credentialsId: 'git-stash-commoncloud-jenkins', url: repoURL]]
    ])
}

def slackSuccess(slackChannel) {
    slackSend (
        channel: slackChannel,
        color: "#008000",
        message: ":blush: *SUCCESS*\nDeployment Completed")
}

def slackFailure(slackChannel) {
    slackSend (
        channel: slackChannel,
        color: "#FF0000",
        message: ":dizzy_face: *FAILURE*\nDeployment Failed")
}
